<html>
    <head>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0">      
      <style type="text/css">

    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      background-color: #1d3557;
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    } 

    #dataToggleContainer {
      background: #f1f1f1;
      padding: 10px;
      text-align: center;
    }

    #dataToggleContainer label {
      margin: 0 15px;
      font-size: 16px;
      cursor: pointer;
    }

    #map {
          height: calc(100vh - 100px); /* adjust for header + toggle bar */
          width: 100%;
    }
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    #footer {
    position: fixed;
    bottom: calc(30px + 0.5rem);
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    font-size: 20px;
    font-family: Lato, sans-serif;
    color: #4C4A57;
    font-style: light;
    width: 100%;
    }

    p {
    font-family: 'Lato', sans-serif;
    font-weight: 300;
    font-size: 16px;
    }

      </style>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
      <title>World Cities Map</title>
    </head>
  <body>
    <header> World Map Viewer </header>
    <!--radio buttons-->
    <div id="dataToggleContainer">
        <label>
        <input type="radio" name="dataToggle" value="cities" checked /> Cities
        </label>
        <label>
        <input type="radio" name="dataToggle" value="railways" /> Railway Lines
        </label>
    </div>
    <div id="map"></div>
     <div id="footer">
        Built on Oracle Databases and Flask
     </div>
    <div id="loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translateX(-50%);
        background-color: #333; color: #fff; padding: 10px 20px; border-radius: 5px; z-index: 1000;">
    </div>     
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> 
   <script>
    // Initial map settings
    const initialLat = 20;
    const initialLng = 0;
    const initialZoom = 2;

    const map = L.map('map').setView([initialLat, initialLng], initialZoom);    
    
    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  
    let currentLayerGroup = L.layerGroup().addTo(map);

    const resetControl = L.control({ position: 'topright' });

    resetControl.onAdd = function () {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = '<a href="#" title="Reset Zoom" style="padding: 5px;">‚ü≥</a>';
        div.style.background = 'white';
        div.style.cursor = 'pointer';
        div.onclick = function () {
        map.setView([initialLat, initialLng], initialZoom);
        };
        return div;
    };

    resetControl.addTo(map);
 

  function showLoading(isLoading,type) {
    const loader = document.getElementById("loading");
    loader.style.display = isLoading ? "block" : "none";
    loader.innerHTML = isLoading ? `‚è≥ Loading ${type} data...` : "";
  }

 
function loadData(type) {
  showLoading(true, type);  // Show loader
  currentLayerGroup.clearLayers();  // Clear existing layers

  const endpoint = type === "cities" ? "/cities" : "/railways";

  if (type === "cities") {
    // Standard full JSON load
    fetch(endpoint)
      .then(response => {
        if (!response.ok) throw new Error(`Failed to fetch ${type}`);
        return response.json();
      })
      .then(data => {
        showLoading(false, type);

        data.forEach(city => {
          L.marker([city.latitude, city.longitude])
            .bindPopup(`<b>${city.name}</b><br>Population: ${city.population}`)
            .addTo(currentLayerGroup);
        });
      })
      .catch(err => {
        showLoading(false, type);
        alert("‚ùå Unable to load cities: " + err.message);
      });

  } 
}

function loadRailwaysStreamed() {
  showLoading(true, 'railways');
  currentLayerGroup.clearLayers();

  fetch('/railways')
    .then(response => {
      if (!response.ok) {
        throw new Error("Failed to fetch railways");
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buffer = "";

      function readChunk() {
        return reader.read().then(({ done, value }) => {
          if (done) {
            showLoading(false, 'railways');
            console.log("‚úÖ Stream complete");
            return;
          }

          buffer += decoder.decode(value, { stream: true });

          // NDJSON => split by line
          let lines = buffer.split("\n");
          buffer = lines.pop(); // Keep partial line if any

          lines.forEach(line => {
            if (line.trim()) {
              try {
                const collection = JSON.parse(line);
                console.log("üìå FeatureCollection chunk:", collection);

                if (collection.type === 'FeatureCollection' && Array.isArray(collection.features)) {
                  collection.features.forEach(feature => {
                    const coords = feature.geometry.coordinates;
                    const flippedCoords = coords.map(coord => [coord[1], coord[0]]);
                    const polyline = L.polyline(flippedCoords, {
                      color: 'red',
                      weight: 2
                    }).bindPopup(`
                      <b>${feature.properties.id}</b><br>
                      ${feature.properties.featurecla}<br>
                      ${feature.properties.part}<br>
                      ${feature.properties.continent}
                    `);
                    currentLayerGroup.addLayer(polyline);
                  });
                } else {
                  console.warn("‚ö†Ô∏è Skipped non-FeatureCollection:", collection);
                }

              } catch (err) {
                console.error("‚ùå JSON parse error:", err);
              }
            }
          });

          return readChunk();
        });
      }

      return readChunk();
    })
    .catch(err => {
      showLoading(false, 'railways');
      alert("‚ùå Stream error: " + err.message);
    });
}


    // Initial load
    loadData("cities");  

    // Event listener for radio buttons
    document.querySelectorAll('input[name="dataToggle"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const selectedType = this.value;
        if (selectedType == "railways") {
          loadRailwaysStreamed(); // Use streamed loading for railways
        } else {
          loadData(selectedType); // Standard loading for cities
        }
      });
    });

  </script>
  </body>
</html>