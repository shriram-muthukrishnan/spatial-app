<html>
    <head>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0">      
      <style type="text/css">

    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      background-color: #1d3557;
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    } 

    #dataToggleContainer {
      background: #f1f1f1;
      padding: 10px;
      text-align: center;
    }

    #dataToggleContainer label {
      margin: 0 15px;
      font-size: 16px;
      cursor: pointer;
    }

    #map {
          height: calc(100vh - 100px); /* adjust for header + toggle bar */
          width: 100%;
    }
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    #footer {
    position: fixed;
    bottom: calc(30px + 0.5rem);
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    font-size: 20px;
    font-family: Lato, sans-serif;
    color: #4C4A57;
    font-style: light;
    width: 100%;
    }

    p {
    font-family: 'Lato', sans-serif;
    font-weight: 300;
    font-size: 16px;
    }

      </style>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
      <title>World Cities Map</title>
    </head>
  <body>
    <header> World Map Viewer </header>
    <!--radio buttons-->
    <div id="dataToggleContainer">
        <label>
        <input type="radio" name="dataToggle" value="cities" checked /> Cities
        </label>
        <label>
        <input type="radio" name="dataToggle" value="railways" /> Railway Lines
        </label>
    </div>
    <div id="map"></div>
     <div id="footer">
        Built on Oracle Databases and Flask
     </div>
    <div id="loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translateX(-50%);
        background-color: #333; color: #fff; padding: 10px 20px; border-radius: 5px; z-index: 1000;">
    </div>     
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> 
   <script>
    // Initial map settings
    const initialLat = 20;
    const initialLng = 0;
    const initialZoom = 2;

    const map = L.map('map').setView([initialLat, initialLng], initialZoom);    
    
    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  
    let currentLayerGroup = L.layerGroup().addTo(map);

    const resetControl = L.control({ position: 'topright' });

    resetControl.onAdd = function () {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = '<a href="#" title="Reset Zoom" style="padding: 5px;">⟳</a>';
        div.style.background = 'white';
        div.style.cursor = 'pointer';
        div.onclick = function () {
        map.setView([initialLat, initialLng], initialZoom);
        };
        return div;
    };

    resetControl.addTo(map);
 
   /*fetch('/cities')
    .then(response => response.json())
    .then(data => {
        console.log("Received city data:", data);
      data.forEach(city => {
        L.marker([city.latitude, city.longitude])
          .addTo(map)
          .bindPopup(`<b>${city.name}</b><br>Population: ${city.population}`);
      });
      console.log("Markers added to the map.");
    });*/

  function showLoading(isLoading,type) {
    const loader = document.getElementById("loading");
    loader.style.display = isLoading ? "block" : "none";
    loader.innerHTML = isLoading ? `⏳ Loading ${type} data...` : "";
  }

  function loadData(type) {
    showLoading(true, type);  // Show loader when fetch starts
    currentLayerGroup.clearLayers(); // Clear previous markers or polylines
    const endpoint = type === "cities" ? "/cities" : "/railways";
      fetch(endpoint)
        .then(response => {
          if (!response.ok) throw new Error(`Failed to fetch ${type}`);
          return response.json();
        })
        .then(data => {
          showLoading(false, type); // Hide loader on success

          if (type === "cities") {
            data.forEach(city => {
              L.marker([city.latitude, city.longitude])
                .bindPopup(`<b>${city.name}</b><br>Population: ${city.population}`)
                .addTo(currentLayerGroup);
            });
          } else if (type === "railways") {
            data.forEach(line => {
              const polyline = L.polyline(line.coordinates, {
                color: 'red',
                weight: 2
              }).bindPopup(`<b>${line.id}</b><br>${line.featurecla}<br>${line.part}<br>${line.continent}`);
              currentLayerGroup.addLayer(polyline);
            });
          }
        })
        .catch(err => {
          showLoading(false, type);
          alert("❌ Unable to load " + type + ": " + err.message);
        });    
    /*fetch('/cities')
      .then(response => {
        if (!response.ok) {
          throw new Error("Failed to fetch city data.");
        }
        return response.json();
      })
      .then(data => {
        showLoading(false); // Hide loader on success
        data.forEach(city => {
          L.marker([city.latitude, city.longitude])
            .addTo(map)
            .bindPopup(`<b>${city.name}</b><br>Population: ${city.population}`);
        });
      })
      .catch(error => {
        showLoading(false); // Hide loader on error
        alert("❌ Unable to load city data. Please try again later.\n" + error.message);
        console.error("Fetch error:", error);
      });

     //function loadRailways() {
    //showLoading(true);

      fetch('/railways')
        .then(response => {
          if (!response.ok) throw new Error("Failed to fetch railway data");
          return response.json();
        })
        .then(data => {
          showLoading(false);

          if (data.length === 0) {
            alert("No railway data available.");
            return;
          }

          data.forEach(line => {
            const polyline = L.polyline(line.coordinates, {
              color: 'red',
              weight: 2
            }).addTo(map);
            polyline.bindPopup(`<b>${line.id}</b><br>${line.featurecla}<br>${line.part}<br>${line.continent}`);
          });
        })
        .catch(err => {
          showLoading(false);
          alert("❌ Unable to load railway data. " + err.message);
          console.error("Railway load error:", err);
        });*/
    };     

    // Initial load
    loadData("cities");  

    // Event listener for radio buttons
    document.querySelectorAll('input[name="dataToggle"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const selectedType = this.value;
        loadData(selectedType);
      });
    });

  </script>
  </body>
</html>